<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL RESET & CONFIGURATION --- */
        body {
            background-color: white; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
            padding: 1cm; 
            min-width: 1200px;
            font-family: 'Sarabun', sans-serif;
        }

        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á --- */

/* 1. ‡∏õ‡∏£‡∏±‡∏ö Header ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á 160px ‡πÅ‡∏•‡πâ‡∏ß */
.header-section {
    display: flex;
    gap: 15px;
    margin-bottom: 25px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
    min-height: 160px;   /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÑ‡∏ß‡πâ‡πÅ‡∏ó‡∏ô */
    height: auto;        /* ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
    border: none;
}

/* 2. ‡∏î‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö */
.table-schedule {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem; 
    margin-top: 20px;    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Gap ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
    table-layout: fixed;
    clear: both;         /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏¢‡∏°‡∏≤‡∏ó‡∏±‡∏ö */
}

/* 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Container ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß */
.print-page-container {
    width: 100%;
    min-height: 100vh;
    padding: 1cm;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    /* justify-content: space-between; <-- ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏´‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö */
}
    

        /* 1. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢) */
        .info-box {
            width: 260px;
            border: 2px solid black; /* ‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏¢‡∏Å */
            padding: 5px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background-color: white;
        }

        .logo-container {
            width: 60px;
            height: 60px;
            margin-bottom: 5px;
        }
        .logo-container img { width: 100%; height: 100%; object-fit: contain; }

        .info-text { font-size: 0.9rem; font-weight: bold; margin-bottom: 0; line-height: 1.2; }
        .info-sub { 
            font-size: 0.8rem; 
            color: #000; 
            margin-top: 5px; 
            text-align: left; 
            width: 100%;
            white-space: normal; 
            line-height: 1.2;
        }

        /* 2. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤) */
        .summary-container {
            flex-grow: 1;
            display: flex;
            border: 2px solid black; /* ‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏¢‡∏Å */
            background-color: white;
        }

        .summary-half {
            width: 50%;
            border-right: 1px solid black;
            display: flex;
            flex-direction: column;
        }
        .summary-half:last-child { border-right: none; }

        .sub-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem; 
            table-layout: fixed;
            height: 100%;
        }

        .sub-table th, .sub-table td {
            border: 1px solid black;
            padding: 2px 4px;
            text-align: center;
            vertical-align: middle;
            white-space: normal; 
            word-wrap: break-word;
            overflow: visible; 
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏ç‡πà */
        .sub-table th { border-top: none; }
        .sub-table tr:last-child td { border-bottom: none; }
        .sub-table tr td:first-child, .sub-table tr th:first-child { border-left: none; }
        .sub-table tr td:last-child, .sub-table tr th:last-child { border-right: none; }

        .sub-table th { background-color: #f0f0f0; height: 20px; font-weight: bold; }
        .text-left { text-align: left !important; padding-left: 4px !important; }
        .text-right { text-align: right !important; padding-right: 4px !important; }
        .footer-row { background-color: #e9ecef; font-weight: bold; }

        /* --- TIMETABLE GRID (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) --- */
        .table-schedule {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem; 
            margin-top: 0; 
            table-layout: fixed; /* ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
        }

        .table-schedule th, 
        .table-schedule td {
            border: 1px solid black !important;
            text-align: center;
            vertical-align: middle;
            padding: 0;
            overflow: visible; /* ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
            height: auto; 
        }

        .table-schedule th {
            background-color: #f0f0f0;
            height: 40px; 
            font-size: 0.75rem;
            white-space: pre-line; 
            line-height: 1.1;
            font-weight: bold;
        }

        .cell-period {
            min-height: 60px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ */
            height: auto; 
            width: 8.33%; /* 12 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå + 11 ‡∏Ñ‡∏≤‡∏ö) */
            position: relative;
            vertical-align: top;
        }

        /* --- CLASS BLOCK (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á) --- */
        .class-block {
            min-height: 60px; 
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            padding: 4px;
            
            white-space: normal; 
            word-wrap: break-word; 
            word-break: break-word;
            overflow: visible; 
        }

        .class-block.multi-period { background-color: #d1ecf1; }
        .lunch-block { 
            background-color: #fff3cd; 
            font-weight: bold; 
            color: #856404; 
            font-size: 0.8rem; 
            height: 100%;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* writing-mode: vertical-rl; ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà */
        }

        .subject-code { 
            font-weight: bold; 
            font-size: 0.75rem; 
            margin-bottom: 2px; 
            width: 100%; 
            line-height: 1.2; 
        }
        .subject-name-text { 
            font-size: 0.75rem; 
            line-height: 1.2; 
            margin-bottom: 2px; 
            width: 100%; 
            font-weight: 600; 
            overflow: visible; 
            white-space: normal;
        }
        .detail-text { 
            font-size: 0.7rem; 
            color: #333; 
            line-height: 1.2; 
            width: 100%; 
            white-space: normal; 
            overflow: visible;
        }

        /* --- SIGNATURE SECTION (‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô) --- */
        .signature-section {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */
        }

        /* --- CONTROL PANEL (‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£) --- */
        .control-panel {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        /* --- PRINT STYLES (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå) --- */
        @media print {
            body { 
                padding: 0; 
                margin: 0;
                width: 297mm; /* A4 Landscape */
                height: 210mm;
                background-color: white;
            }
            .control-panel { display: none !important; }
            .no-print { display: none !important; }
            
            .page-break { 
                page-break-after: always; 
                display: block; 
                clear: both;
            }
            
            /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 1 ‡∏´‡∏ô‡πâ‡∏≤ A4 */
            .print-page-container {
                width: 100%;
                min-height: 100vh; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
                padding: 1cm; /* ‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡∏ö‡∏ô-‡∏Å‡∏•‡∏≤‡∏á-‡∏•‡πà‡∏≤‡∏á */
                page-break-inside: avoid;
                page-break-after: always;
            }

            /* Signature ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
            .signature-section {
                display: flex !important;
                justify-content: space-between;
                margin-top: 15px;
                width: 100%;
                font-size: 10px;
                flex-shrink: 0; /* ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏î */
            }
            .sig-block { text-align: center; width: 22%; }
            .sig-line {
                margin-bottom: 8px;
                border-bottom: 1px dotted #999;
                width: 80%;
                margin-left: auto;
                margin-right: auto;
                height: 15px;
            }
            .sig-name { margin-bottom: 2px; }
            .sig-role { font-weight: bold; font-size: 11px; }

            @page { 
                size: A4 landscape; 
                margin: 0; /* ‡∏ï‡∏±‡∏î Margin Browser */
            }
        }
    </style>
</head>
<body>

    <div class="control-panel no-print">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</h5>
            <div>
                User: <strong><%= user.username %></strong>
                <a href="/logout" class="btn btn-sm btn-outline-danger ms-2">Logout</a>
            </div>
        </div>
        <div class="row g-2">
            <div class="col-md-3">
                <select id="viewType" class="form-select">
                    <option value="group">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    <option value="teacher">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á: ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</option>
                    <option value="room">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á: ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                </select>
            </div>
            <div class="col-md-4">
                <select id="viewItem" class="form-select">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="renderTimetable()">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
            </div>
            
            <div class="col-md-3 d-flex gap-1">
                <div class="btn-group w-100">
                    <button type="button" class="btn btn-danger dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (Current Page)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="printBatch('group')">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Groups)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="printBatch('teacher')">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Teachers)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="printBatch('room')">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Rooms)</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="row g-2 mt-2 justify-content-end">
            <div class="col-md-2">
                <button class="btn btn-success w-100" onclick="exportToCSV()">üìÑ Export CSV</button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-success w-100" onclick="exportToExcel()">üìä Export Excel</button>
            </div>
        </div>
    </div>

    <div id="scheduleContainer" style="display:none;"></div>
    <div id="batchPrintContainer" style="display:none;"></div>

    <script>
        const scheduleData = <%- JSON.stringify(schedule) %>;
        const masterData = {
            groups: <%- JSON.stringify(groups) %>,
            teachers: <%- JSON.stringify(teachers) %>,
            rooms: <%- JSON.stringify(rooms) %>,
            subjects: <%- JSON.stringify(subjects) %>
        };

        const viewTypeSelect = document.getElementById('viewType');
        const viewItemSelect = document.getElementById('viewItem');
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
        const dayNames = { 'Mon':'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', 'Tue':'‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', 'Wed':'‡∏û‡∏∏‡∏ò', 'Thu':'‡∏û‡∏§‡∏´‡∏±‡∏™', 'Fri':'‡∏®‡∏∏‡∏Å‡∏£‡πå' };
        
        const timeSlots = [
            "08.00-09.00", "09.00-10.00", "10.00-11.00", "11.00-12.00",
            "12.00-13.00", 
            "13.00-14.00", "14.00-15.00", "15.00-16.00", "16.00-17.00",
            "17.00-18.00", "18.00-19.00"
        ];

        // --- Helper Function ---
        function getName(type, id) {
            if (type === 'teacher') return (masterData.teachers.find(x => x.teacher_id === id) || {}).teacher_name || id;
            if (type === 'room') return (masterData.rooms.find(x => x.room_id === id) || {}).room_name || id;
            if (type === 'group') return (masterData.groups.find(x => x.group_id === id) || {}).group_name || id;
            if (type === 'subject') return (masterData.subjects.find(x => x.subject_id === id) || {}).subject_name || id;
            return id;
        }

        viewTypeSelect.addEventListener('change', updateItemDropdown);
        function updateItemDropdown() {
            const type = viewTypeSelect.value;
            viewItemSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
            let items = [];
            if (type === 'group') items = masterData.groups.map(g => ({ id: g.group_id, name: `${g.group_id} - ${g.group_name}` }));
            else if (type === 'teacher') items = masterData.teachers.map(t => ({ id: t.teacher_id, name: t.teacher_name }));
            else if (type === 'room') items = masterData.rooms.map(r => ({ id: r.room_id, name: r.room_name }));

            items.sort((a, b) => a.name.localeCompare(b.name));
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name;
                viewItemSelect.appendChild(opt);
            });
        }

        function generatePageHTML(type, id) {
            const mySchedule = scheduleData.filter(s => 
                (type === 'group' && s.group_id === id) ||
                (type === 'teacher' && s.teacher_id === id) ||
                (type === 'room' && s.room_id === id)
            );

            // Info Data
            let label1, val1, label2, val2;
            if (type === 'group') {
                const g = masterData.groups.find(x => x.group_id === id);
                label1 = '‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:'; val1 = g ? g.group_name : id;
                label2 = '‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:'; val2 = g ? g.advisor : '-';
            } else if (type === 'teacher') {
                const t = masterData.teachers.find(x => x.teacher_id === id);
                label1 = '‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π:'; val1 = t ? t.teacher_name : id;
                label2 = '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:'; val2 = t ? t.role : '-';
            } else {
                const r = masterData.rooms.find(x => x.room_id === id);
                label1 = '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:'; val1 = r ? r.room_name : id;
                label2 = '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:'; val2 = r ? r.room_type : '-';
            }

            // Summary Data
            const uniqueSubjIds = [...new Set(mySchedule.map(s => s.subject_id))];
            let summaryList = uniqueSubjIds.map((sid, index) => {
                const subj = masterData.subjects.find(s => s.subject_id === sid) || {};
                const hours = mySchedule.filter(s => s.subject_id === sid).length;
                return { seq: index + 1, code: sid, name: subj.subject_name || '-', t: parseInt(subj.theory||0), p: parseInt(subj.practice||0), c: parseInt(subj.credit||0), h: hours };
            });
            
            let grandTotal = {t:0, p:0, c:0, h:0};
            summaryList.forEach(i => { grandTotal.t+=i.t; grandTotal.p+=i.p; grandTotal.c+=i.c; grandTotal.h+=i.h; });

            const half = Math.ceil(summaryList.length / 2);
            const list1 = summaryList.slice(0, half);
            const list2 = summaryList.slice(half);
            const maxRows = Math.max(list1.length, list2.length, 6);

            const genRows = (list) => {
                let html = '';
                for(let i=0; i<maxRows; i++) {
                    const item = list[i];
                    if(item) html += `<tr><td>${item.seq}</td><td>${item.code}</td><td class="text-left">${item.name}</td><td>${item.t}</td><td>${item.p}</td><td>${item.c}</td><td>${item.h}</td></tr>`;
                    else html += `<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
                }
                return html;
            };

            const genSubtotal = (list) => {
                let s = {t:0, p:0, c:0, h:0};
                list.forEach(i => { s.t+=i.t; s.p+=i.p; s.c+=i.c; s.h+=i.h; });
                return `<tr class="footer-row"><td colspan="3" class="text-right">‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢</td><td>${s.t}</td><td>${s.p}</td><td>${s.c}</td><td>${s.h}</td></tr>`;
            };

            // Table Header with Time
            let headerHtml = `<tr><th style="width:8%">‡∏ß‡∏±‡∏ô / ‡πÄ‡∏ß‡∏•‡∏≤</th>`;
            for(let i=1; i<=11; i++) {
                const timeStr = timeSlots[i-1];
                if(i === 5) {
                    headerHtml += `<th style="width:3%; font-size:0.6rem;">${i}<br>${timeStr}</th>`; 
                } else {
                    headerHtml += `<th>${i}<br>${timeStr}</th>`;
                }
            }
            headerHtml += `</tr>`;

            // Grid Rows
            let gridHtml = '';
            days.forEach(day => {
                gridHtml += `<tr><td style="font-weight:bold">${dayNames[day]}</td>`;
                for (let period = 1; period <= 11; period++) {
                    if (period === 5) {
                        gridHtml += `<td class="cell-period"><div class="lunch-block">‡∏û‡∏±‡∏Å</div></td>`;
                        continue;
                    }
                    const cls = mySchedule.find(s => s.day === day && parseInt(s.period) === period);
                    if (cls) {
                        let duration = 1;
                        for (let k = period + 1; k <= 11; k++) {
                            if (k === 5) break;
                            const next = mySchedule.find(s => s.day === day && parseInt(s.period) === k);
                            if (next && next.subject_id === cls.subject_id) duration++; else break;
                        }
                        
                        const subjName = getName('subject', cls.subject_id);
                        let d1 = '', d2 = '';
                        if(type==='group') { d1=getName('teacher', cls.teacher_id); d2=getName('room', cls.room_id); }
                        else if(type==='teacher') { d1=getName('group', cls.group_id); d2=getName('room', cls.room_id); }
                        else { d1=getName('teacher', cls.teacher_id); d2=getName('group', cls.group_id); }

                        const color = duration > 1 ? 'multi-period' : '';
                        gridHtml += `<td colspan="${duration}" class="cell-period">
                            <div class="class-block ${color}">
                                <div class="subject-code">${cls.subject_id}</div>
                                <div class="subject-name-text">${subjName}</div>
                                <div class="detail-text">${d1}</div>
                                <div class="detail-text">${d2}</div>
                            </div>
                        </td>`;
                        period += (duration - 1);
                    } else {
                        gridHtml += `<td class="cell-period"></td>`;
                    }
                }
                gridHtml += `</tr>`;
            });

            // Return Full Structure
            return `
            <div class="print-page-container">
                <div style="flex-grow: 1;">
                    <div class="header-section">
                        <div class="info-box">
                            <div class="logo-container"><img src="/img/2.png" onerror="this.style.display='none'"></div>
                            <div class="info-text mt-1">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2/2568</div>
                            <div class="info-text">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏±‡∏á‡∏á‡∏≤</div>
                            <hr style="width: 90%; margin: 5px 0; border-top: 2px solid black;">
                            <div class="info-sub"><b>${label1}</b> ${val1}</div>
                            <div class="info-sub"><b>${label2}</b> ${val2}</div>
                        </div>
                        <div class="summary-container">
                            <div class="summary-half">
                                <table class="sub-table">
                                    <thead><tr><th style="width:8%">‡∏ó‡∏µ‡πà</th><th style="width:20%">‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th><th style="width:8%">‡∏ó</th><th style="width:8%">‡∏õ</th><th style="width:8%">‡∏ô</th><th style="width:8%">‡∏ä</th></tr></thead>
                                    <tbody>${genRows(list1)}</tbody>
                                    <tfoot>${genSubtotal(list1)}<tr class="footer-row" style="background-color:white;border:none"><td colspan="7" style="border:none">&nbsp;</td></tr></tfoot>
                                </table>
                            </div>
                            <div class="summary-half">
                                <table class="sub-table">
                                    <thead><tr><th style="width:8%">‡∏ó‡∏µ‡πà</th><th style="width:20%">‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th><th style="width:8%">‡∏ó</th><th style="width:8%">‡∏õ</th><th style="width:8%">‡∏ô</th><th style="width:8%">‡∏ä</th></tr></thead>
                                    <tbody>${genRows(list2)}</tbody>
                                    <tfoot>
                                        ${genSubtotal(list2)}
                                        <tr class="footer-row" style="background-color: #dee2e6; border-top: 2px solid black;">
                                            <td colspan="3" class="text-right">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                                            <td>${grandTotal.t}</td><td>${grandTotal.p}</td><td>${grandTotal.c}</td><td>${grandTotal.h}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <table class="table-schedule">
                        <thead>
                            ${headerHtml}
                        </thead>
                        <tbody>${gridHtml}</tbody>
                    </table>
                </div>

                <div class="signature-section">
                    <div class="sig-block">
                        <div class="sig-line"></div>
                        <div class="sig-name">(.........................................)</div>
                        <div class="sig-role">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</div>
                    </div>
                    <div class="sig-block">
                        <div class="sig-line"></div>
                        <div class="sig-name">(.........................................)</div>
                        <div class="sig-role">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Ø</div>
                    </div>
                    <div class="sig-block">
                        <div class="sig-line"></div>
                        <div class="sig-name">(.........................................)</div>
                        <div class="sig-role">‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</div>
                    </div>
                    <div class="sig-block">
                        <div class="sig-line"></div>
                        <div class="sig-name">(.........................................)</div>
                        <div class="sig-role">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderTimetable() {
            const type = viewTypeSelect.value;
            const id = viewItemSelect.value;
            if(!id) return;

            const container = document.getElementById('scheduleContainer');
            container.innerHTML = generatePageHTML(type, id);
            container.style.display = 'block';
            document.getElementById('batchPrintContainer').innerHTML = ''; 
            document.getElementById('batchPrintContainer').style.display = 'none';
        }

        function printBatch(type) {
            let list = [];
            if(type === 'group') list = masterData.groups;
            else if(type === 'teacher') list = masterData.teachers;
            else list = masterData.rooms;

            if(!confirm(`‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${list.length} ‡∏´‡∏ô‡πâ‡∏≤ ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            document.getElementById('scheduleContainer').style.display = 'none';
            const batchContainer = document.getElementById('batchPrintContainer');
            batchContainer.innerHTML = '';
            batchContainer.style.display = 'block';

            let fullHtml = '';
            list.forEach(item => {
                const id = (type==='group') ? item.group_id : (type==='teacher' ? item.teacher_id : item.room_id);
                fullHtml += generatePageHTML(type, id);
                fullHtml += `<div class="page-break"></div>`;
            });

            batchContainer.innerHTML = fullHtml;

            setTimeout(() => {
                window.print();
            }, 500);
        }

        function exportToCSV() {
            const type = viewTypeSelect.value; const id = viewItemSelect.value;
            let data = scheduleData;
            if (id) data = scheduleData.filter(s => (type === 'group' && s.group_id === id) || (type === 'teacher' && s.teacher_id === id) || (type === 'room' && s.room_id === id));
            let csv = "data:text/csv;charset=utf-8,\uFEFFgroup_id,day,period,subject_id,subject_name,teacher_id,room_id\n";
            data.forEach(r => csv += `${r.group_id},${r.day},${r.period},${r.subject_id},${getName('subject', r.subject_id).replace(/,/g, '')},${r.teacher_id},${r.room_id}\n`);
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "timetable.csv"; link.click();
        }

        function exportToExcel() {
            const c = document.getElementById('scheduleContainer');
            if(c.style.display === 'none' || !c.innerHTML) return alert("‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Export");

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏µ
            const excelStyles = `
                <style>
                    table { border-collapse: collapse; width: 100%; font-family: 'Sarabun', sans-serif; }
                    th, td { border: 0.5pt solid windowtext; text-align: center; vertical-align: middle; padding: 5px; }
                    th { background-color: #f0f0f0; font-weight: bold; }
                    .header-section { display: table; width: 100%; margin-bottom: 20px; }
                    .info-box { display: table-cell; width: 260px; border: 1.5pt solid black; vertical-align: middle; padding: 10px; }
                    .summary-container { display: table-cell; border: 1.5pt solid black; padding: 0; }
                    .summary-half { display: table-cell; width: 50%; border-right: 0.5pt solid black; }
                    .footer-row { background-color: #e9ecef; font-weight: bold; }
                    .class-block { background-color: #ffffff; }
                    .multi-period { background-color: #d1ecf1; }
                    .lunch-block { background-color: #fff3cd; font-weight: bold; }
                    .text-left { text-align: left; }
                    .text-right { text-align: right; }
                </style>
            `;

            const excelTemplate = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                      xmlns:x="urn:schemas-microsoft-com:office:excel" 
                      xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    ${excelStyles}
                </head>
                <body>
                    ${c.innerHTML}
                </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', excelTemplate], {type: 'application/vnd.ms-excel'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'timetable_excel.xls';
            link.click();
        }

        updateItemDropdown();
    </script>
</body>
</html>